pipeline {
    agent any

    environment {
        DOCKER_HUB_REPO = 'leviochana'  // Docker Hub username
        DOCKER_IMAGE = "${DOCKER_HUB_REPO}/flaskimage:latest"  // Flask Docker image name
        MONGO_IMAGE = 'mongo:latest'  // MongoDB Docker image
        EC2_USER = 'ec2-user'  // EC2 user
        BACKEND_IP = ''  // This will be set dynamically from Terraform output

        // SSH Key for EC2
        SSH_KEY = credentials('my-ssh-key')  // SSH Key to access EC2
    }

    stages {
        // Clone the Flask App Repository
        stage('Clone Repository') {
            steps {
                git 'https://github.com/levi-ochana/PokeAPI-Game-with-WebAPI.git'  // Repository URL
            }
        }

        // Initialize Terraform
        stage('Initialize Terraform') {
            steps {
                withCredentials([string(credentialsId: 'aws_access_key_id', variable: 'AWS_ACCESS_KEY_ID'),
                                 string(credentialsId: 'aws_secret_access_key', variable: 'AWS_SECRET_ACCESS_KEY'),
                                 string(credentialsId: 'aws_session_token', variable: 'AWS_SESSION_TOKEN')]) {
                    dir('Deployment') {  // Enter the Deployment directory
                        sh 'terraform init'  // Initialize Terraform
                    }
                }
            }
        }

        // Apply Terraform to create resources (EC2 instances)
        stage('Apply Terraform') {
            steps {
                withCredentials([string(credentialsId: 'aws_access_key_id', variable: 'AWS_ACCESS_KEY_ID'),
                                 string(credentialsId: 'aws_secret_access_key', variable: 'AWS_SECRET_ACCESS_KEY'),
                                 string(credentialsId: 'aws_session_token', variable: 'AWS_SESSION_TOKEN')]) {
                    dir('Deployment') {  // Enter the Deployment directory
                        sh 'terraform apply -auto-approve'  // Apply Terraform configurations
                    }
                }
            }
        }

        // Fetch EC2 IP from Terraform
        stage('Fetch EC2 IP from Terraform') {
            steps {
                script {
                    def terraformOutput = sh(script: "cd Deployment && terraform output -raw backend_instance_ip", returnStdout: true).trim()
                    env.BACKEND_IP = terraformOutput
                    echo "Fetched EC2 IP: ${env.BACKEND_IP}"  // Print the fetched EC2 IP
                }
            }
        }


        // Build the Flask App Docker Image
        stage('Build Docker Image') {
            steps {
                dir('Flask_image') {
                    sh 'docker build -t $DOCKER_IMAGE .'  // Build the Flask Docker image
                }
            }
        }

        // Push the Docker Image to Docker Hub
        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials-username', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh '''
                    echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                    docker push $DOCKER_IMAGE
                    '''
                }
            }
        }
        // Deploy MongoDB on EC2
        stage('Deploy MongoDB') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'my-ssh-key', keyFileVariable: 'SSH_KEY')]) {
                    sh '''
                    ssh -i $SSH_KEY $EC2_USER@$BACKEND_IP << EOF
                    docker run -d --name mongo -p 27017:27017 -v /data/db:/data/db -e MONGO_INITDB_ROOT_USERNAME=admin -e MONGO_INITDB_ROOT_PASSWORD=secret_password mongo

                    EOF
                    '''
                }
            }
        }


        // Deploy Flask App on EC2
        stage('Deploy Flask App') {
            steps {
                sh '''
                ssh -i $SSH_KEY $EC2_USER@$BACKEND_IP << EOF
                  docker pull $DOCKER_IMAGE  // Pull the Flask app Docker image
                  docker stop pokeapi-flask || true  // Stop any existing Flask container
                  docker rm pokeapi-flask || true  // Remove any existing Flask container
                  docker run -d --name pokeapi-flask -p 5000:5000 \
                    --link mongo:mongo \
                    $DOCKER_IMAGE  // Run the Flask app container and link it to MongoDB
                EOF
                '''
            }
        }

        // Check Running Containers
        stage('Check Running Containers') {
            steps {
                sh '''
                ssh -i $SSH_KEY $EC2_USER@$BACKEND_IP << EOF
                  docker ps  // List the running containers on the EC2 instance
                EOF
                '''
            }
        }
    }
}
